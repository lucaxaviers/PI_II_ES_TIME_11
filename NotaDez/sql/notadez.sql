-- ==========================================
-- BANCO DE DADOS: NOTADEZ
-- SISTEMA DE GERENCIAMENTO DE NOTAS
-- ==========================================
-- Autor: Lucas Xavier
-- Projeto: NotaDez (PUC-Campinas - PI2)
-- ==========================================

CREATE TABLE DOCENTE (
    ID_DOCENTE NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME VARCHAR2(100) NOT NULL,
    EMAIL VARCHAR2(100) NOT NULL UNIQUE,
    TELEFONE VARCHAR2(30),
    SENHA VARCHAR2(255) NOT NULL
);

CREATE TABLE INSTITUICAO (
    ID_INSTITUICAO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME VARCHAR2(100) NOT NULL,
    ID_DOCENTE NUMBER NOT NULL,
    CONSTRAINT FK_INST_DOCENTE FOREIGN KEY (ID_DOCENTE)
        REFERENCES DOCENTE (ID_DOCENTE)
        ON DELETE CASCADE
);

CREATE TABLE CURSO (
    ID_CURSO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME VARCHAR2(100) NOT NULL,
    ID_INSTITUICAO NUMBER NOT NULL,
    CONSTRAINT FK_CURSO_INSTITUICAO FOREIGN KEY (ID_INSTITUICAO)
        REFERENCES INSTITUICAO (ID_INSTITUICAO)
        ON DELETE CASCADE
);

CREATE TABLE DISCIPLINA (
    ID_DISCIPLINA NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME VARCHAR2(100) NOT NULL,
    SIGLA VARCHAR2(10) NOT NULL,
    CODIGO VARCHAR2(50),
    PERIODO VARCHAR2(50),
    ID_CURSO NUMBER NOT NULL,
    CONSTRAINT FK_DISC_CURSO FOREIGN KEY (ID_CURSO)
        REFERENCES CURSO (ID_CURSO)
        ON DELETE CASCADE
);

CREATE TABLE TURMA (
    ID_TURMA NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME VARCHAR2(100) NOT NULL,
    CODIGO VARCHAR2(50),
    ID_DISCIPLINA NUMBER NOT NULL,
    CONSTRAINT FK_TURMA_DISC FOREIGN KEY (ID_DISCIPLINA)
        REFERENCES DISCIPLINA (ID_DISCIPLINA)
        ON DELETE CASCADE
);

CREATE TABLE ALUNO (
    ID_ALUNO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    MATRICULA VARCHAR2(20) NOT NULL UNIQUE,
    NOME VARCHAR2(100) NOT NULL,
    ID_TURMA NUMBER NOT NULL,
    CONSTRAINT FK_ALUNO_TURMA FOREIGN KEY (ID_TURMA)
        REFERENCES TURMA (ID_TURMA)
        ON DELETE CASCADE
);

CREATE TABLE COMPONENTE_NOTA (
    ID_COMPONENTE NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME VARCHAR2(100) NOT NULL,
    SIGLA VARCHAR2(10) NOT NULL,
    DESCRICAO VARCHAR2(255),
    ID_DISCIPLINA NUMBER NOT NULL,
    CONSTRAINT FK_COMP_DISC FOREIGN KEY (ID_DISCIPLINA)
        REFERENCES DISCIPLINA (ID_DISCIPLINA)
        ON DELETE CASCADE
);

CREATE TABLE NOTA (
    ID_NOTA NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_ALUNO NUMBER NOT NULL,
    ID_COMPONENTE NUMBER NOT NULL,
    VALOR NUMBER(4,2) CHECK (VALOR BETWEEN 0 AND 10),
    CONSTRAINT FK_NOTA_ALUNO FOREIGN KEY (ID_ALUNO)
        REFERENCES ALUNO (ID_ALUNO)
        ON DELETE CASCADE,
    CONSTRAINT FK_NOTA_COMPONENTE FOREIGN KEY (ID_COMPONENTE)
        REFERENCES COMPONENTE_NOTA (ID_COMPONENTE)
        ON DELETE CASCADE,
    CONSTRAINT UQ_NOTA_UNICA UNIQUE (ID_ALUNO, ID_COMPONENTE)
);

CREATE TABLE AUDITORIA_NOTA (
    ID_AUDITORIA NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_NOTA NUMBER NOT NULL,
    DATA_HORA TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    VALOR_ANTIGO NUMBER(4,2),
    VALOR_NOVO NUMBER(4,2),
    DESCRICAO VARCHAR2(255),
    CONSTRAINT FK_AUD_NOTA FOREIGN KEY (ID_NOTA)
        REFERENCES NOTA (ID_NOTA)
        ON DELETE CASCADE
);

CREATE OR REPLACE TRIGGER TG_AUDITORIA_NOTA
AFTER UPDATE OF VALOR ON NOTA
FOR EACH ROW
BEGIN
    INSERT INTO AUDITORIA_NOTA (ID_NOTA, VALOR_ANTIGO, VALOR_NOVO, DESCRICAO)
    VALUES (:OLD.ID_NOTA, :OLD.VALOR, :NEW.VALOR,
        'Nota alterada de ' || :OLD.VALOR || ' para ' || :NEW.VALOR);
END;
/

SELECT A.NOME, 
       ROUND(AVG(N.VALOR), 2) AS MEDIA_FINAL
FROM ALUNO A
JOIN NOTA N ON A.ID_ALUNO = N.ID_ALUNO
JOIN COMPONENTE_NOTA C ON N.ID_COMPONENTE = C.ID_COMPONENTE
WHERE A.ID_TURMA = :ID_TURMA
GROUP BY A.NOME;

INSERT INTO DOCENTE (NOME, EMAIL, SENHA)
VALUES ('Lucas Xavier', 'lucas@teste.com', '123');
COMMIT; 
